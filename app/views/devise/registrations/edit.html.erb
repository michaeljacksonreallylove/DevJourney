<div class="container">
  <div class="row justify-content-center">
    <div class="col-12 col-md-9 col-lg-9">
      <div id="profile-page" class="page-content active">
        <div class="profile-container">
          <h1 class="page-title mb-5 text-center">プロフィール編集</h1>

          <%= form_for(resource, as: resource_name, url: registration_path(resource_name), html: { method: :put }) do |f| %>
            <div class="mb-5">
              <%= image_tag resource.avatar.url, id: 'avatar_preview', class: 'avatar-preview', alt: ' アバター画像' %>
              <%= f.file_field :avatar, id: 'avatar_input', class: "form-control", accept: 'image/*', style: 'display:none;' %> 
            </div>

            <div class="mb-4">
              <%= f.label :name, class: "form-label" %><br />
              <%= f.text_field :name, class: "form-control", placeholder: "名前を入力してください" %>
            </div>

            <div class="mb-4">
              <%= f.label :introduction, class: "form-label" %>
              <%= f.text_area :introduction, class: "form-control", placeholder: "簡単な自己紹介文を入力してください", rows: 6 %>
            </div>

            <div class="mb-4">
              <%= f.label :github_url, class: "form-label" %>
              <%= f.url_field :github_url, class: "form-control", placeholder: "https://github.com/yourusername" %>
            </div>

            <div class="mb-2">
              <%= f.label :devjourney_id, class: "form-label" %>
              <% if resource && resource.errors[:devjourney_id].present? %>
                <div class="field-error">
                  <% resource.errors.full_messages_for(:devjourney_id).each do |msg| %>
                    <div class="field-error-item"><%= msg %></div>
                  <% end %>
                </div>
              <% end %>
              <%= f.text_field :devjourney_id, class: "form-control", placeholder: "devjourney_yourname" %>
            </div>
            <div class="form-text">他のユーザーと重複してはいけません。</div>

            <div class="row g-3 mt-4">
              <div class="col-6">
                <%= link_to "戻る", current_user.profile_page_uri, class: "btn btn-back w-100" %>
              </div>
              <div class="col-6">
                <%= f.submit "更新", class: "btn btn-submit w-100" %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>


<script>
  document.addEventListener('DOMContentLoaded', () => {
    const avatarInput = document.getElementById('avatar_input');
    const avatarPreview = document.getElementById('avatar_preview');
    if (!avatarInput || !avatarPreview) return; // ガード節

    let lastObjectUrl = null;

    // ファイル選択時はObject URLを作ってプレビューを即時更新、キャンセルなら元に戻す
    avatarInput.addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) {
        if (lastObjectUrl) { URL.revokeObjectURL(lastObjectUrl); lastObjectUrl = null; }
        return;
      }

      if (lastObjectUrl) { URL.revokeObjectURL(lastObjectUrl); lastObjectUrl = null; }

      const url = URL.createObjectURL(file);
      lastObjectUrl = url;
      avatarPreview.src = url;
      avatarPreview.onload = () => {
        URL.revokeObjectURL(url);
        if (lastObjectUrl === url) lastObjectUrl = null;
      };
    });

    // 画像クリックでファイル選択をトリガー
    avatarPreview.style.cursor = 'pointer';
    avatarPreview.addEventListener('click', () => { avatarInput.click(); });
  });
</script>
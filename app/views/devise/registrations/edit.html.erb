<h2>Edit <%= resource_name.to_s.humanize %></h2>

<%= form_for(resource, as: resource_name, url: registration_path(resource_name), html: { method: :put }) do |f| %>
  <%= render "devise/shared/error_messages", resource: resource %>

  <div class="field">
    <%= f.label :name %><br />
    <%= f.text_field :name, class: "form-control" %>
  </div>

  <div class="field">
    <%= f.label :introduction %><br />
    <%= f.text_area :introduction, rows: 4, class: "form-control" %>
  </div>

  <div class="field">
    <%= f.label :github_url %><br />
    <%= f.url_field :github_url, class: "form-control", placeholder: "https://github.com/yourname" %>
  </div>

  <div class="field">
    <%= f.label :devjourney_id %><br />
    <%= f.text_field :devjourney_id, autocomplete: "username", class: "form-control", placeholder: "devjourney_yourname" %>
  </div>

  <div class="field">
    <%= f.label :avatar %><br />

    <!-- Preview (shows existing avatar if present, otherwise blank) -->
    <% if resource.avatar.present? %>
      <%= image_tag resource.avatar.url, id: 'avatar_preview', class: 'avatar-preview', alt: 'avatar preview', data: { has: true }, tabindex: 0 %>
    <% else %>
      <img id="avatar_preview" class="avatar-preview" alt="avatar preview" src="" data-has="false" style="display:none;" tabindex="0" />
    <% end %>

  <%= f.file_field :avatar, class: "form-control", id: 'avatar_input', accept: 'image/*', style: 'display:none;' %>
  </div>

  <div class="actions">
    <%= f.submit "Update" %>
  </div>
<% end %>

<%= link_to "Back", :back %>

<script>
document.addEventListener('DOMContentLoaded', function() {
  var input = document.getElementById('avatar_input');
  var preview = document.getElementById('avatar_preview');
  if (!input || !preview) return;

  // show preview initially if server-side indicated an existing avatar
  try {
    var has = preview.getAttribute('data-has');
    preview.style.display = (has === 'true') ? '' : 'none';
  } catch (e) {}

  var lastObjectUrl = null;

  input.addEventListener('change', function(e) {
    var file = e.target.files && e.target.files[0];
    if (!file) {
      var has = preview.getAttribute('data-has');
      preview.style.display = (has === 'true') ? '' : 'none';
      if (lastObjectUrl) { URL.revokeObjectURL(lastObjectUrl); lastObjectUrl = null; }
      return;
    }

    if (lastObjectUrl) { URL.revokeObjectURL(lastObjectUrl); lastObjectUrl = null; }

    var url = URL.createObjectURL(file);
    lastObjectUrl = url;
    preview.src = url;
    preview.style.display = '';
    preview.onload = function() { URL.revokeObjectURL(url); if (lastObjectUrl === url) lastObjectUrl = null; };
  });

  // clicking the preview opens the file chooser (file input is still visible per request)
  preview.style.cursor = 'pointer';
  preview.addEventListener('click', function() { input.click(); });
  preview.addEventListener('keydown', function(e) { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); input.click(); } });
});
</script>
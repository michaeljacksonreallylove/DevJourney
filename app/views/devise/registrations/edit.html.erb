<h2>Edit <%= resource_name.to_s.humanize %></h2>

<%= form_for(resource, as: resource_name, url: registration_path(resource_name), html: { method: :put }) do |f| %>
  <%= render "devise/shared/error_messages", resource: resource %>

  <div class="field">
    <%= f.label :name %><br />
    <%= f.text_field :name, class: "form-control" %>
  </div>

  <div class="field">
    <%= f.label :introduction %><br />
    <%= f.text_area :introduction, rows: 4, class: "form-control" %>
  </div>

  <div class="field">
    <%= f.label :github_url %><br />
    <%= f.url_field :github_url, class: "form-control", placeholder: "https://github.com/yourname" %>
  </div>

  <div class="field">
    <%= f.label :devjourney_id %><br />
    <%= f.text_field :devjourney_id, autocomplete: "username", class: "form-control", placeholder: "devjourney_yourname" %>
  </div>

  <div class="field">
    <%= f.label :avatar %><br />
    <%= image_tag resource.avatar.url, id: 'avatar_preview', class: 'avatar-preview', alt: ' アバター画像' %>
    <%= f.file_field :avatar, id: 'avatar_input', class: "form-control", accept: 'image/*', style: 'display:none;' %> 
  </div>

  <div class="actions">
    <%= f.submit "Update" %>
  </div>
<% end %>

<%= link_to "Back", :back %>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const avatarInput = document.getElementById('avatar_input');
  const avatarPreview = document.getElementById('avatar_preview');
  if (!avatarInput || !avatarPreview) return; // ガード節

  let lastObjectUrl = null;

  // ファイル選択時はObject URLを作ってプレビューを即時更新、キャンセルなら元に戻す
  avatarInput.addEventListener('change', (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) {
      if (lastObjectUrl) { URL.revokeObjectURL(lastObjectUrl); lastObjectUrl = null; }
      return;
    }

    if (lastObjectUrl) { URL.revokeObjectURL(lastObjectUrl); lastObjectUrl = null; }

    const url = URL.createObjectURL(file);
    lastObjectUrl = url;
    avatarPreview.src = url;
    avatarPreview.onload = () => {
      URL.revokeObjectURL(url);
      if (lastObjectUrl === url) lastObjectUrl = null;
    };
  });

  // 画像クリックでファイル選択をトリガー
  avatarPreview.style.cursor = 'pointer';
  avatarPreview.addEventListener('click', () => { avatarInput.click(); });
});
</script>